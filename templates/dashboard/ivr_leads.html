{% extends 'dashboard/base.html' %}
{% load static %}

{% block page_title %}IVR Leads{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>IVR Leads Management</h2>
                <div>
                    <button class="btn btn-success me-2" onclick="sendWhatsAppCampaign()">
                        <i class="fab fa-whatsapp"></i> Send WhatsApp to Today's Leads
                    </button>
                    <button class="btn btn-success me-2" onclick="syncFromIVRPanel()">
                        <i class="fas fa-sync"></i> Clear & Sync Real Data
                    </button>
                    <button class="btn btn-info" onclick="refreshAnalytics()">
                        <i class="fas fa-chart-bar"></i> Refresh Analytics
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total IVR Leads</h5>
                    <h3>{{ stats.total_leads }}</h3>
                    <small>All time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Quality Leads</h5>
                    <h3>{{ stats.quality_leads }}</h3>
                    <small>Duration > 1 minute</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Junk Leads</h5>
                    <h3>{{ stats.junk_leads }}</h3>
                    <small>Missed/Short calls</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Conversion Rate</h5>
                    <h3>{{ stats.conversion_rate }}%</h3>
                    <small>Quality rate</small>
                </div>
            </div>
        </div>
    </div>



    <!-- Recent Calls and Leads -->
    <div class="row">
        <!-- Recent IVR Calls -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Recent IVR Calls</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Phone</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for call in recent_calls %}
                                <tr>
                                    <td>{{ call.caller_id_number }}</td>
                                    <td>{{ call.call_duration_formatted }}</td>
                                    <td>
                                        {% if call.processed %}
                                            <span class="badge bg-success">Processed</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No calls found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Leads -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Quality Leads</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Project</th>
                                    <th>Stage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in quality_leads %}
                                <tr>
                                    <td>
                                        <a href="{% url 'view_lead' lead.id %}">{{ lead.name }}</a>
                                    </td>
                                    <td>{{ lead.phone }}</td>
                                    <td>
                                        {% for project in lead.interested_projects.all %}
                                            <small class="badge bg-info me-1">{{ project.name }}</small>
                                        {% empty %}
                                            <small class="text-muted">No project</small>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="badge" style="background-color: {{ lead.current_stage.color }}">
                                            {{ lead.current_stage.name }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No quality leads</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Junk Leads -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Junk Leads</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Project</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in junk_leads %}
                                <tr>
                                    <td>
                                        <a href="{% url 'view_lead' lead.id %}">{{ lead.name }}</a>
                                    </td>
                                    <td>{{ lead.phone }}</td>
                                    <td>
                                        {% for project in lead.interested_projects.all %}
                                            <small class="badge bg-secondary me-1">{{ project.name }}</small>
                                        {% empty %}
                                            <small class="text-muted">No project</small>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if "Missed" in lead.notes %}Missed Call{% else %}Short Call{% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No junk leads</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
<script>
function sendWhatsAppCampaign() {
    if (!confirm('Send WhatsApp templates to all today\'s IVR leads?')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('/send-whatsapp-ivr-leads/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const results = data.results;
            alert(`WhatsApp Campaign Complete!\nSent: ${results.sent_successfully}\nFailed: ${results.failed}\nTotal Leads: ${results.total_leads}`);
        } else {
            alert('Error: ' + data.message);
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-whatsapp"></i> Send WhatsApp to Today\'s Leads';
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-whatsapp"></i> Send WhatsApp to Today\'s Leads';
    });
}

function syncFromIVRPanel() {
    if (!confirm('Sync latest calls from TATA panel to CRM leads?')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('/sync-ivr-data/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const summary = data.summary;
            alert(`âœ… Live Sync Complete!\nTotal calls: ${summary.total_calls}\nNew leads: ${summary.new_leads_created}\nUpdated leads: ${summary.updated_leads}`);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Sync Latest TATA Calls';
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Sync Latest TATA Calls';
    });
}



function refreshAnalytics() {
    fetch('/ivr-lead-analytics/')
        .then(response => response.json())
        .then(data => {
            console.log('Analytics refreshed:', data);
            location.reload();
        });
}


</script>
{% endblock %}